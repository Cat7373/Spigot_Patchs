From 91c5270071363c7ecd1366749af6a052545ad1ff Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Thu, 3 Mar 2016 02:02:07 -0600
Subject: [PATCH] Paper -> Optimize Pathfinding

如果连续 8 次寻路都是失败的，就暂时禁止该实体的寻路(40 tick)。
Link：https://github.com/PaperMC/Paper/blob/master/Spigot-Server-Patches/0063-Optimize-Pathfinding.patch

diff --git a/src/main/java/net/minecraft/server/NavigationAbstract.java b/src/main/java/net/minecraft/server/NavigationAbstract.java
index 2f4265a..821985c 100644
--- a/src/main/java/net/minecraft/server/NavigationAbstract.java
+++ b/src/main/java/net/minecraft/server/NavigationAbstract.java
@@ -118,10 +118,26 @@ public abstract class NavigationAbstract {
     }
 
     public boolean a(Entity entity, double d0) {
+        // Paper start - Pathfinding optimizations
+        if (this.pathfindFailures > 8 && this.c == null && MinecraftServer.currentTick < this.lastFailure + 40) {
+            return false;
+        }
+
         PathEntity pathentity = this.a(entity);
 
-        return pathentity != null ? this.a(pathentity, d0) : false;
+        if (pathentity != null && this.a(pathentity, d0)) {
+            this.lastFailure = 0;
+            this.pathfindFailures = 0;
+            return true;
+        } else {
+            this.pathfindFailures++;
+            this.lastFailure = MinecraftServer.currentTick;
+            return false;
+        }
     }
+    private int lastFailure = 0;
+    private int pathfindFailures = 0;
+    // Paper end
 
     public boolean a(PathEntity pathentity, double d0) {
         if (pathentity == null) {
@@ -254,6 +270,7 @@ public abstract class NavigationAbstract {
     }
 
     public void o() {
+        this.pathfindFailures = 0; this.lastFailure = 0; // Paper - Pathfinding optimizations
         this.c = null;
     }
 
-- 
2.7.2.windows.1
