From 48a9bc5b23dce2f052854637d9fbbd2a1508aca5 Mon Sep 17 00:00:00 2001
From: Cat73 <root@cat73.org>
Date: Sun, 10 Mar 2019 22:05:36 +0800
Subject: [PATCH] Cat73 -> Don't load chunks for villager door checks
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

不要在村庄检测门时加载区块

Link: https://github.com/PaperMC/Paper/blob/988887d2b053d4ef34935b7671cc20d2c7eb920a/Spigot-Server-Patches/0260-Configurable-Villages-loading-chunks-for-door-checks.patch

diff --git a/src/main/java/net/minecraft/server/PersistentVillage.java b/src/main/java/net/minecraft/server/PersistentVillage.java
index 98c6bbc1..140bc976 100644
--- a/src/main/java/net/minecraft/server/PersistentVillage.java
+++ b/src/main/java/net/minecraft/server/PersistentVillage.java
@@ -136,7 +136,7 @@ public class PersistentVillage extends PersistentBase {
             for (int j = -4; j < 4; ++j) {
                 for (int k = -16; k < 16; ++k) {
                     blockposition_mutableblockposition.g(blockposition).d(i, j, k);
-                    IBlockData iblockdata = this.world.getType(blockposition_mutableblockposition);
+                    IBlockData iblockdata = this.world.getTypeIfLoaded(blockposition_mutableblockposition); // Paper
 
                     if (this.a(iblockdata)) {
                         VillageDoor villagedoor = this.c(blockposition_mutableblockposition);
@@ -228,7 +228,7 @@ public class PersistentVillage extends PersistentBase {
     }
 
     private boolean a(IBlockData iblockdata) {
-        return iblockdata.getBlock() instanceof BlockDoor && iblockdata.getMaterial() == Material.WOOD;
+        return iblockdata != null && iblockdata.getBlock() instanceof BlockDoor && iblockdata.getMaterial() == Material.WOOD;
     }
 
     public void a(NBTTagCompound nbttagcompound) {
diff --git a/src/main/java/net/minecraft/server/Village.java b/src/main/java/net/minecraft/server/Village.java
index 68ad7bc2..cbeb2571 100644
--- a/src/main/java/net/minecraft/server/Village.java
+++ b/src/main/java/net/minecraft/server/Village.java
@@ -11,10 +11,10 @@ import javax.annotation.Nullable;
 
 public class Village {
 
-    private World a;
+    private World a; private World getWorld() { return a; } // Paper - OBFHELPER
     private final List<VillageDoor> b = Lists.newArrayList();
     private BlockPosition c;
-    private BlockPosition d;
+    private BlockPosition d; private BlockPosition getCenter() { return d; } // Paper - OBFHELPER
     private int e;
     private int f;
     private int g;
@@ -44,6 +44,12 @@ public class Village {
     }
 
     public void a(int i) {
+        // Paper - don't tick village if chunk isn't loaded
+        Chunk chunk = getWorld().getChunkIfLoaded(getCenter());
+        if (chunk == null || !chunk.areNeighborsLoaded(1)) {
+            return;
+        }
+        // Paper end
         this.g = i;
         this.m();
         this.l();
@@ -292,6 +298,12 @@ public class Village {
 
         while (iterator.hasNext()) {
             VillageDoor villagedoor = (VillageDoor) iterator.next();
+            // Paper start - don't remove doors from unloaded chunks
+            if (!getWorld().isLoaded(villagedoor.getPosition())) {
+                villagedoor.setLastSeen(villagedoor.getLastSeen() + 1);
+                continue;
+            }
+            // Paper end
 
             if (flag1) {
                 villagedoor.a();
@@ -312,7 +324,9 @@ public class Village {
     }
 
     private boolean g(BlockPosition blockposition) {
-        IBlockData iblockdata = this.a.getType(blockposition);
+        IBlockData iblockdata = this.a.getTypeIfLoaded(blockposition); // Paper
+        if (iblockdata == null) return false; // Paper
+
         Block block = iblockdata.getBlock();
 
         return block instanceof BlockDoor ? iblockdata.getMaterial() == Material.WOOD : false;
diff --git a/src/main/java/net/minecraft/server/VillageDoor.java b/src/main/java/net/minecraft/server/VillageDoor.java
index 33ad5faa..1edffc46 100644
--- a/src/main/java/net/minecraft/server/VillageDoor.java
+++ b/src/main/java/net/minecraft/server/VillageDoor.java
@@ -55,6 +55,7 @@ public class VillageDoor {
         return this.f;
     }
 
+    public BlockPosition getPosition() { return d(); } // Paper - OBFHELPER
     public BlockPosition d() {
         return this.a;
     }
@@ -71,10 +72,12 @@ public class VillageDoor {
         return this.c.getAdjacentZ() * 2;
     }
 
+    public int getLastSeen() { return h(); } // Paper - OBFHELPER
     public int h() {
         return this.d;
     }
 
+    public void setLastSeen(int i) { a(i); } // Paper - OBFHELPER
     public void a(int i) {
         this.d = i;
     }
-- 
2.21.0

