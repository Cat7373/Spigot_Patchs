From 07e6dfe4d85232cc65d684ab372430f349f92fd7 Mon Sep 17 00:00:00 2001
From: Cat73 <root@cat73.org>
Date: Tue, 25 Feb 2020 23:16:28 +0800
Subject: [PATCH] Cat73 -> Optimize Hoppers
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

漏斗优化在 API 层面做的改动

Link: https://github.com/PaperMC/Paper/blob/892f479fb4ef849ba834cbedd0069395cc1bef14/Spigot-API-Patches/0084-Optimize-Hoppers.patch

diff --git a/src/main/java/org/bukkit/event/inventory/InventoryMoveItemEvent.java b/src/main/java/org/bukkit/event/inventory/InventoryMoveItemEvent.java
index a8c48f5a..04d4a83b 100644
--- a/src/main/java/org/bukkit/event/inventory/InventoryMoveItemEvent.java
+++ b/src/main/java/org/bukkit/event/inventory/InventoryMoveItemEvent.java
@@ -31,6 +31,8 @@ public class InventoryMoveItemEvent extends Event implements Cancellable {
     private final Inventory destinationInventory;
     private ItemStack itemStack;
     private final boolean didSourceInitiate;
+    public boolean calledGetItem; // Paper
+    public boolean calledSetItem; // Paper
 
     public InventoryMoveItemEvent(@NotNull final Inventory sourceInventory, @NotNull final ItemStack itemStack, @NotNull final Inventory destinationInventory, final boolean didSourceInitiate) {
         Validate.notNull(itemStack, "ItemStack cannot be null");
@@ -58,7 +60,8 @@ public class InventoryMoveItemEvent extends Event implements Cancellable {
      */
     @NotNull
     public ItemStack getItem() {
-        return itemStack.clone();
+        calledGetItem = true; // Paper - record this method was used for auto detection of mode
+        return itemStack; // Paper - Removed clone, handled better in Server
     }
 
     /**
@@ -70,6 +73,7 @@ public class InventoryMoveItemEvent extends Event implements Cancellable {
      */
     public void setItem(@NotNull ItemStack itemStack) {
         Validate.notNull(itemStack, "ItemStack cannot be null.  Cancel the event if you want nothing to be transferred.");
+        calledSetItem = true; // Paper - record this method was used for auto detection of mode
         this.itemStack = itemStack.clone();
     }
 
-- 
2.25.0

